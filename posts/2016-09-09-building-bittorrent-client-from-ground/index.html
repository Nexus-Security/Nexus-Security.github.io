<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=robots content="all"><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=bingbot content="index,follow"><link rel=sitemap type=application/xml title=Sitemap href=https://nexus-security.github.io/sitemap.xml><meta property="og:type" content="article"><meta name=author content="0x000216"><meta property="og:locale" content="en"><meta name=language content="English"><base href=https://Nexus-Security.github.io/posts/2016-09-09-building-bittorrent-client-from-ground/><link rel=icon href=/fav.ico type=image/x-icon><link rel=alternate type=application/rss+xml title=RSS href=https://nexus-security.github.io/index.xml><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="BitTorrent is a protocol for downloading and distributing files across the Internet. In contrast with the traditional client/server relationship, in which downloaders connect to a central server (for example: watching a movie on Netflix, or loading the web page you’re reading now), participants in the BitTorrent network, called peers, download pieces of files from each other—this is what makes it a peer-to-peer protocol. We’ll investigate how this works, and build our own client that can find peers and exchange data between them."><title>Building a BitTorrent client from the ground up in Go</title><link rel=canonical href=https://Nexus-Security.github.io/posts/2016-09-09-building-bittorrent-client-from-ground/><link rel=stylesheet href=/scss/style.min.1f3200acb41251d94439982f0ccc8f6599efd31eaa9b4d6412b905bc3d5fa0b8.css><meta property="og:title" content="Building a BitTorrent client from the ground up in Go"><meta property="og:description" content="BitTorrent is a protocol for downloading and distributing files across the Internet. In contrast with the traditional client/server relationship, in which downloaders connect to a central server (for example: watching a movie on Netflix, or loading the web page you’re reading now), participants in the BitTorrent network, called peers, download pieces of files from each other—this is what makes it a peer-to-peer protocol. We’ll investigate how this works, and build our own client that can find peers and exchange data between them."><meta property="og:url" content="https://Nexus-Security.github.io/posts/2016-09-09-building-bittorrent-client-from-ground/"><meta property="og:site_name" content="0x000216"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:published_time" content="2020-01-05T01:38:00+01:00"><meta property="article:modified_time" content="2020-01-05T01:38:00+01:00"><meta name=twitter:title content="Building a BitTorrent client from the ground up in Go"><meta name=twitter:description content="BitTorrent is a protocol for downloading and distributing files across the Internet. In contrast with the traditional client/server relationship, in which downloaders connect to a central server (for example: watching a movie on Netflix, or loading the web page you’re reading now), participants in the BitTorrent network, called peers, download pieces of files from each other—this is what makes it a peer-to-peer protocol. We’ll investigate how this works, and build our own client that can find peers and exchange data between them."><link rel="shortcut icon" href=/fav.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"light")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button>
<center><header><figure class=site-avatar><a href=/><center><img src=/img/avatar_hue825486955cd7c56d95e38b4bd2a8e3c_229979_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></center></a></figure><div class=site-meta><h2 class=site-name><a href=/>0x000216</a></h1><h2 class=site-description>Where Do Russian Hackers Store Their Exploits? 🤓 /ussr/bin/ 😋</h2></div></header></center><ol class=social-menu><li><a href=https://github.com/Nexus-Security target=_blank title=GitHub><svg width="72" height="72" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M36 72c19.882251.0 36-16.117749 36-36 0-19.882251-16.117749-36-36-36-19.882251 365231026e-23-36 16.117749-36 36C24348735e-22 55.882251 16.117749 72 36 72z" fill="#3e75c3"/><path d="M35.9985 12C22.746 12 12 22.7870921 12 36.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 59.1797862 30.0525 58.4358488 30.0525 57.7973276 30.0525 57.2250681 30.0315 55.7100863 30.0195 53.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 45.4500754 19.4355 45.4801943 19.4355 45.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 48.4077535 30.9345 47.3460615 31.62 46.7436831 26.2905 46.1352808 20.688 44.0691228 20.688 34.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 27.7597262 22.0875 25.3110578 23.3925 21.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 23.9285993 33.96 23.6620468 36.0015 23.6515052 38.04 23.6620468 40.0935 23.9285993 42.0105 24.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 25.3110578 49.089 27.7597262 48.8415 28.3696344 50.3805 30.0547881 51.309 32.2052792 51.309 34.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 54.4089489 41.9505 57.0067059 41.9505 57.7973276 41.9505 58.4418726 42.3825 59.1918338 43.6005 58.9554002 53.13 55.7627944 60 46.7376593 60 36.096644 60 22.7870921 49.254 12 35.9985 12" fill="#fff"/></g></svg></a></li><li><a href=mailto:0x000216@gmail.com target=_blank title=Email><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#e6f3ff" d="M512 105.739v300.522c0 27.715-22.372 50.087-50.087 50.087H50.087C22.372 456.348.0 433.976.0 406.261V105.739c0-.89.0-1.781.111-2.671 1.336-25.6 21.704-45.969 47.304-47.304.89-.111 1.781-.111 2.671-.111h411.826c.89.0 1.892.0 2.783.111 25.489 1.336 45.857 21.704 47.193 47.193C512 103.847 512 104.849 512 105.739z"/><path style="fill:#cfdbe6" d="M464.696 55.763c-.892-.111-1.891-.111-2.783-.111H256v400.696h205.913c27.715.0 50.087-22.372 50.087-50.087V105.739c0-.89.0-1.892-.111-2.783C510.553 77.468 490.184 57.099 464.696 55.763z"/><path style="fill:#ff4b26" d="M511.889 102.957c-1.336-25.489-21.704-45.857-47.193-47.193C382.89 137.569 336.951 183.509 256 264.459 225.291 233.732 77.61 85.958 47.416 55.763c-25.6 1.336-45.969 21.704-47.304 47.304C0 103.958.0 104.849.0 105.739v300.522c0 27.715 22.372 50.087 50.087 50.087h16.696V169.739l165.621 165.51c6.456 6.567 15.026 9.795 23.597 9.795 8.57.0 17.141-3.228 23.597-9.795l165.621-165.621v286.72h16.696c27.715.0 50.087-22.372 50.087-50.087V105.739C512 104.849 512 103.847 511.889 102.957z"/><path style="fill:#d93f21" d="M279.596 335.249l165.621-165.621v286.72h16.696c27.715.0 50.087-22.372 50.087-50.087V105.739c0-.89.0-1.892-.111-2.783-1.336-25.489-21.704-45.857-47.193-47.193C382.891 137.569 336.951 183.509 256 264.459v80.584C264.57 345.043 273.141 341.816 279.596 335.249z"/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a></li><li><a href=https://nexus-security.github.io/index.xml target=_blank title=RSS><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><path style="fill:#f78c20" d="M78.333 355.334C35.14 355.334.0 390.474.0 433.667S35.14 512 78.333 512s78.333-35.14 78.333-78.333-35.14-78.333-78.333-78.333z"/><g><path style="fill:#ffa929" d="M78.333 381.445c-28.795.0-52.222 23.427-52.222 52.222s23.427 52.222 52.222 52.222 52.222-23.427 52.222-52.222-23.427-52.222-52.222-52.222z"/><path style="fill:#ffa929" d="M477.918 264.861c-21.843-51.641-53.111-98.019-92.936-137.842-39.824-39.824-86.201-71.093-137.843-92.935C193.669 11.468 136.874.0 78.333.0c-4.807.0-8.704 3.897-8.704 8.704v85.519c0 4.807 3.897 8.704 8.704 8.704 182.37.0 330.74 148.369 330.74 330.74.0 4.807 3.897 8.704 8.704 8.704h85.52c4.807.0 8.704-3.897 8.704-8.704C512 375.126 500.533 318.331 477.918 264.861z"/><path style="fill:#ffa929" d="M78.333 163.853c-4.807.0-8.704 3.897-8.704 8.704v95.74c0 4.807 3.897 8.704 8.704 8.704 86.386.0 156.666 70.281 156.666 156.666.0 4.807 3.897 8.704 8.704 8.704h95.74c4.807.0 8.704-3.897 8.704-8.704.0-72.07-28.065-139.826-79.027-190.787-50.961-50.961-118.717-79.027-190.787-79.027z"/></g><g><path style="fill:#f78c20" d="M78.333 242.186c-2.918.0-5.817.076-8.704.206v25.905c0 4.807 3.897 8.704 8.704 8.704 86.386.0 156.666 70.281 156.666 156.666.0 4.807 3.897 8.704 8.704 8.704h25.905c.129-2.886.206-5.786.206-8.704.0-105.752-85.729-191.481-191.481-191.481z"/><path style="fill:#f78c20" d="M78.333 68.113c-2.91.0-5.81.042-8.704.11v26.001c0 4.807 3.897 8.704 8.704 8.704 182.37.0 330.74 148.369 330.74 330.74.0 4.807 3.897 8.704 8.704 8.704h26.001c.067-2.894.11-5.793.11-8.704C443.887 231.777 280.223 68.113 78.333 68.113z"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a></li><li><a href target=_blank title=Slack><svg width="256" height="256" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid"><path d="M165.964 15.838c-3.89-11.975-16.752-18.528-28.725-14.636-11.975 3.89-18.528 16.752-14.636 28.725l58.947 181.365c4.048 11.187 16.132 17.473 27.732 14.135 12.1-3.483 19.475-16.334 15.614-28.217L165.964 15.838" fill="#dfa22f"/><path d="M74.626 45.516C70.734 33.542 57.873 26.989 45.9 30.879 33.924 34.77 27.37 47.631 31.263 59.606l58.948 181.366c4.047 11.186 16.132 17.473 27.732 14.132 12.099-3.481 19.474-16.332 15.613-28.217L74.626 45.516" fill="#3cb187"/><path d="M240.162 166.045c11.975-3.89 18.526-16.75 14.636-28.726-3.89-11.973-16.752-18.527-28.725-14.636L44.708 181.632c-11.187 4.046-17.473 16.13-14.135 27.73 3.483 12.099 16.334 19.475 28.217 15.614l181.372-58.93" fill="#ce1e5b"/><path d="M82.508 217.27l43.347-14.084-14.086-43.352-43.35 14.09 14.089 43.347" fill="#392538"/><path d="M173.847 187.591c16.388-5.323 31.62-10.273 43.348-14.084l-14.088-43.36-43.35 14.09 14.09 43.354" fill="#bb242a"/><path d="M210.484 74.706c11.974-3.89 18.527-16.751 14.637-28.727-3.89-11.973-16.752-18.526-28.727-14.636L15.028 90.293C3.842 94.337-2.445 106.422.896 118.022c3.481 12.098 16.332 19.474 28.217 15.613l181.371-58.93" fill="#72c5cd"/><path d="M52.822 125.933c11.805-3.836 27.025-8.782 43.354-14.086-5.323-16.39-10.273-31.622-14.084-43.352l-43.36 14.092 14.09 43.346" fill="#248c73"/><path d="M144.16 96.256l43.356-14.088a546179.21 546179.21.0 00-14.089-43.36L130.07 52.9l14.09 43.356" fill="#62803a"/></svg></a></li><li><a href=https://www.minds.com/0x000216/ target=_blank title=Minds><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512"><g><g><path style="fill:#ffe1b2" d="M256 33.085C245.078 13.38 224.079.0 2e2.0c-23.781.0-45.57 13.293-56.594 34.184C115.711 41.602 96 66.977 96 96c0 .059.0.113.0.172-9.977 7.512-16 19.301-16 31.828.0 1.316.078 2.637.234 3.992C60.211 145.266 48 167.758 48 192c0 14.07 4.039 27.543 11.719 39.262C57.273 236.512 56 242.207 56 248c0 2.738.281 5.445.828 8.098C36.672 267.308 24 288.539 24 312c0 27.973 18.305 52.34 44.109 60.785C65.398 378.828 64 385.324 64 392c0 21.098 13.805 39.508 33.539 45.727C103.891 466.746 129.828 488 160 488c4.617.0 9.227-.512 13.766-1.527C181.992 502 198.141 512 216 512c16.687.0 31.396-8.567 40-21.523V33.085z"/></g><g><g><path style="fill:#ffb980" d="M264 256c-4.422.0-8-3.582-8-8 0-22.055-17.945-40-40-40-8.008.0-15.734 2.355-22.336 6.812-3.023 2.043-7.055 1.781-9.797-.652-3.156-2.809-8.477-6.16-15.867-6.16-4.422.0-8-3.582-8-8s3.578-8 8-8c7.711.0 15.234 2.293 21.719 6.539C197.773 194.246 206.758 192 216 192c30.875.0 56 25.121 56 56C272 252.418 268.422 256 264 256z"/></g></g><g><g><path style="fill:#ffb980" d="M120 120c18.977.0 36.875 7.312 50.414 20.594 3.141 3.09 8.203 3.047 11.312-.109 3.094-3.152 3.047-8.219-.109-11.312C165.07 112.941 143.187 104 120 104c-13.046.0-25.395 2.93-36.542 8.046C81.253 117.019 80 122.423 80 128c0 1.316.078 2.637.234 3.992-.094.062-.173.139-.267.202C91.423 124.501 105.193 120 120 120z"/></g></g><g><g><path style="fill:#ffb980" d="M216 360c0-4.418-3.578-8-8-8s-8 3.582-8 8c0 17.645-14.352 32-32 32-14.211.0-26.82-9.648-30.664-23.465-.703-2.512-2.578-4.523-5.039-5.395-2.453-.871-5.188-.492-7.305 1.02C114.094 371.906 101.305 376 88 376c-6.948.0-13.625-1.149-19.894-3.207-2.214 4.939-3.501 10.19-3.916 15.586C71.714 390.73 79.711 392 88 392c13.297.0 26.187-3.266 37.773-9.52C133.969 397.894 150.141 408 168 408c26.469.0 48-21.531 48-48z"/></g></g><g><path style="fill:#fdc88e" d="M488 312c0-23.461-12.672-44.691-32.828-55.902.547-2.652.828-5.359.828-8.098.0-5.793-1.273-11.488-3.719-16.738C459.961 219.543 464 206.07 464 192c0-24.242-12.211-46.734-32.234-60.008.156-1.355.234-2.676.234-3.992.0-12.527-6.023-24.316-16-31.828.0-.059.0-.113.0-.172.0-29.023-19.711-54.398-47.406-61.816C357.57 13.293 335.781.0 312 0c-24.08.0-45.078 13.38-56 33.085v457.391C264.604 503.433 279.313 512 296 512c17.859.0 34.008-10 42.234-25.527C342.773 487.488 347.383 488 352 488c30.172.0 56.109-21.254 62.461-50.273C434.195 431.508 448 413.097 448 392c0-6.676-1.398-13.172-4.109-19.215C469.695 364.34 488 339.973 488 312z"/></g><g><path style="fill:#f8ab6b" d="M272.008 151.199C272 151.465 272 151.734 272 152c0 26.469 21.531 48 48 48s48-21.531 48-48c0-4.418-3.578-8-8-8s-8 3.582-8 8c0 17.645-14.352 32-32 32s-32-14.355-32-32c0-2.184.219-4.359.656-6.465.492-2.395-.133-4.883-1.703-6.754-1.57-1.871-4.016-3.066-6.352-2.859-.453.012-.891.059-.602.078-13.234.0-24-10.766-24-24v31.813C260.673 147.348 266.061 149.988 272.008 151.199z"/></g><g><path style="fill:#f8ab6b" d="M296 328c9.242.0 18.219-2.246 26.281-6.539C328.765 325.707 336.289 328 344 328c4.422.0 8-3.582 8-8s-3.578-8-8-8c-7.391.0-12.711-3.352-15.867-6.16-2.742-2.434-6.766-2.695-9.797-.656C311.726 309.644 304 312 296 312c-22.055.0-40-17.945-40-40v39.116C266.174 321.517 280.337 328 296 328z"/></g><g><g><path style="fill:#f8ab6b" d="M431.765 131.992c.156-1.355.234-2.676.234-3.992.0-5.577-1.253-10.981-3.458-15.954C417.395 106.93 405.046 104 392 104c-4.422.0-8 3.582-8 8s3.578 8 8 8c14.807.0 28.577 4.501 40.032 12.194C431.939 132.131 431.859 132.054 431.765 131.992z"/></g></g><g><g><path style="fill:#f8ab6b" d="M447.81 388.38c-.415-5.396-1.702-10.647-3.916-15.586C437.624 374.85 430.948 376 424 376c-13.578.0-26.594-4.266-37.641-12.332-2.07-1.5-4.719-1.93-7.133-1.168-2.43.77-4.344 2.648-5.164 5.059C369.101 382.176 355.414 392 340 392c-4.422.0-8 3.582-8 8s3.578 8 8 8c18.875.0 35.961-10.191 45.094-26.156C396.976 388.512 410.258 392 424 392 432.288 392 440.285 390.73 447.81 388.38z"/></g></g></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a></li><li><a href=https://www.buymeacoffee.com/0x000216 target=_blank title=Coffee><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 340 340" style="enable-background:new 0 0 340 340"><g id="XMLID_18_"><polygon id="XMLID_138_" style="fill:#dedde0" points="76.429,290 80,340 170,340 170,290"/><polygon id="XMLID_169_" style="fill:#dedde0" points="170,80 61.429,80 65,130 170,130"/><polygon id="XMLID_197_" style="fill:#acabb1" points="170,290 170,340 260,340 263.571,290"/><polygon id="XMLID_221_" style="fill:#acabb1" points="170,80 170,130 275,130 278.571,80"/><path id="XMLID_222_" style="fill:#ffda44" d="M170 260c-22.091.0-40-22.386-40-50s17.909-50 40-50v-30H65 50l10 160h16.429H170V260z"/><path id="XMLID_33_" style="fill:#ff9811" d="M170 130v30c22.091.0 40 22.386 40 50s-17.909 50-40 50v30h93.571H280l10-160h-15H170z"/><path id="XMLID_223_" style="fill:#50412e" d="M210 210c0-27.614-17.909-50-40-50v1e2c22.091.0 40-22.386 40-50z"/><path id="XMLID_224_" style="fill:#786145" d="M130 210c0 27.614 17.909 50 40 50V160c-22.091.0-40 22.386-40 50z"/><polygon id="XMLID_225_" style="fill:#50412e" points="278.571,80 300,80 300,40 260,40 260,0 80,0 80,40 40,40 40,80 61.429,80 170,80"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About Us</span></a></li><li><a href=/termsofservice/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-pencil" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 20h4L18.5 9.5a1.5 1.5.0 00-4-4L4 16v4"/><line x1="13.5" y1="6.5" x2="17.5" y2="10.5"/></svg><span>Terms Of Service</span></a></li><li><a href=/privacypolicy/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Privacy Policy</span></a></li><li><a href=/disclaimer/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Disclaimer</span></a></li><li><a href=/contact/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mail" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="5" width="18" height="14" rx="2"/><polyline points="3 7 12 13 21 7"/></svg><span>Contact Us</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/posts/2016-09-09-building-bittorrent-client-from-ground/>Building a BitTorrent client from the ground up in Go</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jan 05, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>17 minute read</time></div></footer></div></header><section class=article-content><p>BitTorrent is a protocol for downloading and distributing files across the Internet. In contrast with the traditional client/server relationship, in which downloaders connect to a central server (for example: watching a movie on Netflix, or loading the web page you’re reading now), participants in the BitTorrent network, called <strong>peers</strong>, download pieces of files from <em>each other</em>—this is what makes it a <strong>peer-to-peer</strong> protocol. We’ll investigate how this works, and build our own client that can find peers and exchange data between them.</p><p><img src=https://blog.jse.li/torrent/client-server-p2p.png loading=lazy alt="diagram showing the difference between client/server (all clients connecting to one server) and peer-to-peer (peers connecting to each other) relationships"></p><p>The protocol evolved organically over the past 20 years, and various people and organizations added extensions for features like encryption, private torrents, and new ways of finding peers. We’ll be implementing the <a class=link href=https://www.bittorrent.org/beps/bep_0003.html target=_blank rel=noopener>original spec</a> from 2001 to keep this a weekend-sized project.</p><p>I’ll be using a <a class=link href=https://cdimage.debian.org/debian-cd/current/amd64/bt-cd/#indexlist target=_blank rel=noopener>Debian ISO</a> file as my guinea pig because it’s big, but not huge, at 350MB. As a popular Linux distribution, there will be lots of fast and cooperative peers for us to connect to. And we’ll avoid the legal and ethical issues related to downloading pirated content.</p><h1 id=finding-peers>Finding peers</h1><p>Here’s a problem: we want to download a file with BitTorrent, but it’s a peer-to-peer protocol and we have no idea where to find peers to download it from. This is a lot like moving to a new city and trying to make friends—maybe we’ll hit up a local pub or a meetup group! Centralized locations like these are the big idea behind <strong>trackers</strong>, which are central servers that introduce peers to each other. They’re just web servers running over HTTP*Some trackers use a <a class=link href=http://bittorrent.org/beps/bep_0015.html target=_blank rel=noopener>UDP</a> binary protocol to save bandwidth , and you can find Debian’s at <a class=link href=http://bttracker.debian.org:6969/ target=_blank rel=noopener>http://bttracker.debian.org:6969/</a></p><p><img src=https://blog.jse.li/torrent/trackers.png loading=lazy alt="illustration of a desktop computer and laptop sitting at a pub"></p><p>Of course, these central servers are liable to get raided by the feds if they facilitate peers exchanging illegal content. You may remember reading about trackers like TorrentSpy, Popcorn Time, and KickassTorrents getting seized and shut down. New methods cut out the middleman by making even <strong>peer discovery</strong> a distributed process. We won’t be implementing them, but if you’re interested, some terms you can research are <strong>DHT</strong>, <strong>PEX</strong>, and <strong>magnet links</strong>.</p><h2 id=parsing-a-torrent-file>Parsing a .torrent file</h2><p>A .torrent file describes the contents of a torrentable file and information for connecting to a tracker. It’s all we need in order to kickstart the process of downloading a torrent. Debian’s .torrent file looks like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>d8:announce41:http://bttracker.debian.org:6969/announce7:comment35:&#34;Debian CD from cdimage.debian.org&#34;13:creation datei1573903810e9:httpseedsl145:https://cdimage.debian.org/cdimage/release/10.2.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-10.2.0-amd64-netinst.iso145:https://cdimage.debian.org/cdimage/archive/10.2.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-10.2.0-amd64-netinst.isoe4:infod6:lengthi351272960e4:name31:debian-10.2.0-amd64-netinst.iso12:piece lengthi262144e6:pieces26800:�����PS�^�� (binary blob of the hashes of each piece)ee 
</span></span></code></pre></td></tr></table></div></div><p>That mess is encoded in a format called <strong>Bencode</strong> (pronounced <em>bee-encode</em>), and we’ll need to decode it.</p><p>Bencode can encode roughly the same types of structures as JSON—strings, integers, lists, and dictionaries. Bencoded data is not as human-readable/writable as JSON, but it can efficiently handle binary data and it’s really simple to parse from a stream. Strings come with a length prefix, and look like <code>4:spam</code>. Integers go between <em>start</em> and <em>end</em> markers, so <code>7</code> would encode to <code>i7e</code>. Lists and dictionaries work in a similar way: <code>l4:spami7ee</code> represents <code>['spam', 7]</code>, while <code>d4:spami7ee</code> means <code>{spam: 7}</code>.</p><p>In a prettier format, our .torrent file looks like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>`d 8:announce 41:http://bttracker.debian.org:6969/announce 7:comment 35:&#34;Debian CD from cdimage.debian.org&#34; 13:creation date i1573903810e 4:info d 6:length i351272960e 4:name 31:debian-10.2.0-amd64-netinst.iso 12:piece length i262144e 6:pieces 26800:�����PS�^�� (binary blob of the hashes of each piece)` e e
</span></span></code></pre></td></tr></table></div></div><p>In this file, we can spot the URL of the tracker, the creation date (as a Unix timestamp), the name and size of the file, and a big binary blob containing the SHA-1 hashes of each <strong>piece</strong>, which are equally-sized parts of the file we want to download. The exact size of a piece varies between torrents, but they are usually somewhere between 256KB and 1MB. This means that a large file might be made up of <em>thousands</em> of pieces. We’ll download these pieces from our peers, check them against the hashes from our torrent file, assemble them together, and boom, we’ve got a file!</p><p><img src=https://blog.jse.li/torrent/pieces.png loading=lazy alt="illustration of a file being cut with scissors into multiple pieces, starting with piece 0"></p><p>This mechanism allows us to verify the integrity of each piece as we go. It makes BitTorrent resistant to accidental corruption or intentional <strong>torrent poisoning</strong>. Unless an attacker is capable of breaking SHA-1 with a preimage attack, we will get exactly the content we asked for.</p><p>It would be really fun to write a bencode parser, but parsing isn’t our focus today. But I found Fredrik Lundh’s <a class=link href=https://effbot.org/zone/bencode.htm target=_blank rel=noopener>50 line parser</a> to be especially illuminating. For this project, I used <a class=link href=https://github.com/jackpal/bencode-go target=_blank rel=noopener>github.com/jackpal/bencode-go</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>import ( &#34;github.com/jackpal/bencode-go&#34; ) type bencodeInfo struct { Pieces string `bencode:&#34;pieces&#34;` PieceLength int `bencode:&#34;piece length&#34;` Length int `bencode:&#34;length&#34;` Name string `bencode:&#34;name&#34;` } type bencodeTorrent struct { Announce string `bencode:&#34;announce&#34;` Info bencodeInfo `bencode:&#34;info&#34;` } // Open parses a torrent file func Open(r io.Reader) (*bencodeTorrent, error) { bto := bencodeTorrent{} err := bencode.Unmarshal(r, &amp;bto) if err != nil { return nil, err } return &amp;bto, nil }
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://github.com/veggiedefender/torrent-client/blob/2bde944888e1195e81cc5d5b686f6ec3a9f08c25/torrentfile/torrentfile.go target=_blank rel=noopener>view in context</a></p><p>Because I like to keep my structures relatively flat, and I like to keep my application structs separate from my serialization structs, I exported a different, flatter struct named <code>TorrentFile</code> and wrote a few helper functions to convert between the two.</p><p>Notably, I split <code>pieces</code> (previously a string) into a slice of hashes (each <code>[20]byte</code>) so that I can easily access individual hashes later. I also computed the SHA-1 hash of the entire bencoded <code>info</code> dict (the one which contained the name, size, and piece hashes). We know this as the <strong>infohash</strong> and it uniquely identifies files when we talk to trackers and peers. More on this later.</p><p><img src=https://blog.jse.li/torrent/info-hash.png loading=lazy alt="a name tag saying &lsquo;Hello my name is 86d4c80024a469be4c50bc5a102cf71780310074&rsquo;"></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>type TorrentFile struct { Announce string InfoHash [20]byte PieceHashes [][20]byte PieceLength int Length int Name string } func (bto *bencodeTorrent) toTorrentFile() (*TorrentFile, error) { // ... }
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://github.com/veggiedefender/torrent-client/blob/2bde944888e1195e81cc5d5b686f6ec3a9f08c25/torrentfile/torrentfile.go#L120-L138 target=_blank rel=noopener>view in context</a></p><h2 id=retrieving-peers-from-the-tracker>Retrieving peers from the tracker</h2><p>Now that we have information about the file and its tracker, let’s talk to the tracker to <strong>announce</strong> our presence as a peer and to retrieve a list of other peers. We just need to make a GET request to the <code>announce</code> URL supplied in the .torrent file, with a few query parameters:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (t *TorrentFile) buildTrackerURL(peerID [20]byte, port uint16) (string, error) { base, err := url.Parse(t.Announce) if err != nil { return &#34;&#34;, err } params := url.Values{ &#34;info_hash&#34;: []string{string(t.InfoHash[:])}, &#34;peer_id&#34;: []string{string(peerID[:])}, &#34;port&#34;: []string{strconv.Itoa(int(Port))}, &#34;uploaded&#34;: []string{&#34;0&#34;}, &#34;downloaded&#34;: []string{&#34;0&#34;}, &#34;compact&#34;: []string{&#34;1&#34;}, &#34;left&#34;: []string{strconv.Itoa(t.Length)}, } base.RawQuery = params.Encode() return base.String(), nil }
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://github.com/veggiedefender/torrent-client/blob/2bde944888e1195e81cc5d5b686f6ec3a9f08c25/torrentfile/tracker.go#L19-L35 target=_blank rel=noopener>view in context</a></p><p>The important ones:</p><ul><li><strong>info_hash</strong>: Identifies the <em>file</em> we’re trying to download. It’s the infohash we calculated earlier from the bencoded <code>info</code> dict. The tracker will use this to figure out which peers to show us.</li><li><strong>peer_id</strong>: A 20 byte name to identify <em>ourselves</em> to trackers and peers. We’ll just generate 20 random bytes for this. Real BitTorrent clients have IDs like <code>-TR2940-k8hj0wgej6ch</code> which identify the client software and version—in this case, TR2940 stands for Transmission client 2.94.</li></ul><p><img src=https://blog.jse.li/torrent/info-hash-peer-id.png loading=lazy alt="a file with a name tag saying &lsquo;info_hash&rsquo; and a person with a name tag &lsquo;peer_id&rsquo;"></p><h2 id=parsing-the-tracker-response>Parsing the tracker response</h2><p>We get back a bencoded response:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>d 8:interval i900e 5:peers 252:(another long binary blob) e
</span></span></code></pre></td></tr></table></div></div><p><code>Interval</code> tells us how often we’re supposed to connect to the tracker again to refresh our list of peers. A value of 900 means we should reconnect every 15 minutes (900 seconds).</p><p><code>Peers</code> is another long binary blob containing the IP addresses of each peer. It’s made out of <strong>groups of six bytes</strong>. The first four bytes in each group represent the peer’s IP address—each byte represents a number in the IP. The last two bytes represent the port, as a big-endian <code>uint16</code>. <strong>Big-endian</strong>, or <strong>network order</strong>, means that we can interpret a group of bytes as an integer by just squishing them together left to right. For example, the bytes <code>0x1A</code>, <code>0xE1</code> make <code>0x1AE1</code>, or 6881 in decimal.*Interpreting the same bytes in <strong>little-endian</strong> order would make 0xE11A = 57626</p><p><img src=https://blog.jse.li/torrent/address.png loading=lazy alt="diagram showing how 192, 0, 2, 123, 0x1A, 0xE1 can be interpreted as 192.0.1.123:6881"></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// Peer encodes connection information for a peer type Peer struct { IP net.IP Port uint16 } // Unmarshal parses peer IP addresses and ports from a buffer func Unmarshal(peersBin []byte) ([]Peer, error) { const peerSize = 6 // 4 for IP, 2 for port  numPeers := len(peersBin) / peerSize if len(peersBin)%peerSize != 0 { err := fmt.Errorf(&#34;Received malformed peers&#34;) return nil, err } peers := make([]Peer, numPeers) for i := 0; i &lt; numPeers; i++ { offset := i * peerSize peers[i].IP = net.IP(peersBin[offset : offset+4]) peers[i].Port = binary.BigEndian.Uint16([]byte(peersBin[offset+4 : offset+6])) } return peers, nil }
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://github.com/veggiedefender/torrent-client/blob/2bde944888e1195e81cc5d5b686f6ec3a9f08c25/peers/peers.go target=_blank rel=noopener>view in context</a></p><h1 id=downloading-from-peers>Downloading from peers</h1><p>Now that we have a list of peers, it’s time to connect with them and start downloading pieces! We can break down the process into a few steps. For each peer, we want to:</p><ol><li>Start a TCP connection with the peer. This is like starting a phone call.</li><li>Complete a two-way BitTorrent <strong>handshake</strong>. <em>“Hello?” “Hello.”</em></li><li>Exchanging <strong>messages</strong> to download <strong>pieces</strong>. <em>“I’d like piece #231 please.”</em></li></ol><h2 id=start-a-tcp-connection>Start a TCP connection</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>conn, err := net.DialTimeout(&#34;tcp&#34;, peer.String(), 3*time.Second) if err != nil { return nil, err }
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://github.com/veggiedefender/torrent-client/blob/2bde944888e1195e81cc5d5b686f6ec3a9f08c25/client/client.go#L65-L69 target=_blank rel=noopener>view in context</a></p><p>I set a timeout so that I don’t waste too much time on peers that aren’t going to let me connect. For the most part, it’s a pretty standard TCP connection.</p><h2 id=complete-the-handshake>Complete the handshake</h2><p>We’ve just set up a connection with a peer, but we want do a handshake to validate our assumptions that the peer</p><ul><li>can communicate using the BitTorrent protocol</li><li>is able to understand and respond to our messages</li><li>has the file that we want, or at least knows what we’re talking about</li></ul><p><img src=https://blog.jse.li/torrent/handshake.png loading=lazy alt="Two computers communicating. One asks &lsquo;do you speak BitTorrent and have this file?&rsquo; and the other replies &lsquo;I speak BitTorrent and have that file&rsquo;"></p><p>My father told me that the secret to a good handshake is a firm grip and eye contact. The secret to a good BitTorrent handshake is that it’s made up of five parts:</p><ol><li>The length of the protocol identifier, which is always 19 (0x13 in hex)</li><li>The protocol identifier, called the <strong>pstr</strong> which is always <code>BitTorrent protocol</code></li><li>Eight <strong>reserved bytes</strong>, all set to 0. We’d flip some of them to 1 to indicate that we support certain <a class=link href=http://www.bittorrent.org/beps/bep_0010.html target=_blank rel=noopener>extensions</a>. But we don’t, so we’ll keep them at 0.</li><li>The <strong>infohash</strong> that we calculated earlier to identify which file we want</li><li>The <strong>Peer ID</strong> that we made up to identify ourselves</li></ol><p>Put together, a handshake string might look like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>\x13BitTorrent protocol\x00\x00\x00\x00\x00\x00\x00\x00\x86\xd4\xc8\x00\x24\xa4\x69\xbe\x4c\x50\xbc\x5a\x10\x2c\xf7\x17\x80\x31\x00\x74-TR2940-k8hj0wgej6ch
</span></span></code></pre></td></tr></table></div></div><p>After we send a handshake to our peer, we should receive a handshake back in the same format. The infohash we get back should match the one we sent so that we know that we’re talking about the same file. If everything goes as planned, we’re good to go. If not, we can sever the connection because there’s something wrong. <em>“Hello?” “这是谁？ 你想要什么？” “Okay, wow, wrong number.”</em></p><p>In our code, let’s make a struct to represent a handshake, and write a few methods for serializing and reading them:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// A Handshake is a special message that a peer uses to identify itself type Handshake struct { Pstr string InfoHash [20]byte PeerID [20]byte } // Serialize serializes the handshake to a buffer func (h *Handshake) Serialize() []byte { pstrlen := len(h.Pstr) bufLen := 49 + pstrlen buf := make([]byte, bufLen) buf[0] = byte(pstrlen) copy(buf[1:], h.Pstr) // Leave 8 reserved bytes  copy(buf[1+pstrlen+8:], h.InfoHash[:]) copy(buf[1+pstrlen+8+20:], h.PeerID[:]) return buf } // Read parses a handshake from a stream func Read(r io.Reader) (*Handshake, error) { // Do Serialize(), but backwards  // ... }
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://github.com/veggiedefender/torrent-client/blob/2bde944888e1195e81cc5d5b686f6ec3a9f08c25/handshake/handshake.go target=_blank rel=noopener>view in context</a></p><h2 id=send-and-receive-messages>Send and receive messages</h2><p>Once we’ve completed the initial handshake, we can send and receive <strong>messages</strong>. Well, not quite—if the other peer isn’t ready to accept messages, we can’t send any until they tell us they’re ready. In this state, we’re considered <strong>choked</strong> by the other peer. They’ll send us an <strong>unchoke</strong> message to let us know that we can begin asking them for data. By default, we assume that we’re choked until proven otherwise.</p><p>Once we’ve been unchoked, we can then begin sending <strong>requests</strong> for pieces, and they can send us messages back containing pieces.</p><p><img src=https://blog.jse.li/torrent/choke.png loading=lazy alt="A cartoon in which person 1 says &lsquo;hello I would like piece number—&rsquo; and person 2 grabs him by the neck and says &lsquo;00 00 00 01 00 (choke)&rsquo;"></p><h3 id=interpreting-messages>Interpreting messages</h3><p>A message has a length, an <strong>ID</strong> and a <strong>payload</strong>. On the wire, it looks like:</p><p><img src=https://blog.jse.li/torrent/message.png loading=lazy alt="A message with 4 byte for the length, 1 byte for ID, and an optional payload"></p><p>A message starts with a length indicator which tells us how many bytes long the message will be. It’s a 32-bit integer, meaning it’s made out of four bytes smooshed together in big-endian order. The next byte, the <strong>ID</strong>, tells us which type of message we’re receiving—for example, a <code>2</code> byte means “interested.” Finally, the optional <strong>payload</strong> fills out the remaining length of the message.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=n>type</span><span class=w> </span><span class=n>messageID</span><span class=w> </span><span class=n>uint8</span><span class=w> </span><span class=nf>const</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>MsgChoke</span><span class=w> </span><span class=n>messageID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=n>MsgUnchoke</span><span class=w> </span><span class=n>messageID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>MsgInterested</span><span class=w> </span><span class=n>messageID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=n>MsgNotInterested</span><span class=w> </span><span class=n>messageID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=n>MsgHave</span><span class=w> </span><span class=n>messageID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=n>MsgBitfield</span><span class=w> </span><span class=n>messageID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=n>MsgRequest</span><span class=w> </span><span class=n>messageID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>6</span><span class=w> </span><span class=n>MsgPiece</span><span class=w> </span><span class=n>messageID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>7</span><span class=w> </span><span class=n>MsgCancel</span><span class=w> </span><span class=n>messageID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>8</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=o>//</span><span class=w> </span><span class=n>Message</span><span class=w> </span><span class=n>stores</span><span class=w> </span><span class=n>ID</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=n>type</span><span class=w> </span><span class=n>Message</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=err>{</span><span class=w> </span><span class=n>ID</span><span class=w> </span><span class=n>messageID</span><span class=w> </span><span class=n>Payload</span><span class=w> </span><span class=p>[]</span><span class=n>byte</span><span class=w> </span><span class=err>}</span><span class=w> </span><span class=o>//</span><span class=w> </span><span class=n>Serialize</span><span class=w> </span><span class=n>serializes</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>form</span><span class=w> </span><span class=o>//</span><span class=w> </span><span class=o>//</span><span class=w> </span><span class=n>Interprets</span><span class=w> </span><span class=o>`</span><span class=n>nil</span><span class=o>`</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>keep</span><span class=o>-</span><span class=n>alive</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=nf>func</span><span class=w> </span><span class=p>(</span><span class=n>m</span><span class=w> </span><span class=o>*</span><span class=n>Message</span><span class=p>)</span><span class=w> </span><span class=nf>Serialize</span><span class=p>()</span><span class=w> </span><span class=p>[]</span><span class=n>byte</span><span class=w> </span><span class=err>{</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>nil</span><span class=w> </span><span class=err>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nf>make</span><span class=p>([]</span><span class=n>byte</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=err>}</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=nf>uint32</span><span class=p>(</span><span class=nf>len</span><span class=p>(</span><span class=n>m</span><span class=p>.</span><span class=n>Payload</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>//</span><span class=w> </span><span class=o>+</span><span class=mi>1</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>id</span><span class=w>  </span><span class=n>buf</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=nf>make</span><span class=p>([]</span><span class=n>byte</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=o>+</span><span class=n>length</span><span class=p>)</span><span class=w> </span><span class=k>binary</span><span class=p>.</span><span class=n>BigEndian</span><span class=p>.</span><span class=nf>PutUint32</span><span class=p>(</span><span class=n>buf</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>4</span><span class=p>],</span><span class=w> </span><span class=n>length</span><span class=p>)</span><span class=w> </span><span class=n>buf</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>byte</span><span class=p>(</span><span class=n>m</span><span class=p>.</span><span class=n>ID</span><span class=p>)</span><span class=w> </span><span class=nf>copy</span><span class=p>(</span><span class=n>buf</span><span class=p>[</span><span class=mi>5</span><span class=p>:],</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=n>Payload</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=err>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://github.com/veggiedefender/torrent-client/blob/2bde944888e1195e81cc5d5b686f6ec3a9f08c25/message/message.go#L90-L103 target=_blank rel=noopener>view in context</a></p><p>To read a message from a stream, we just follow the format of a message. We read four bytes and interpret them as a <code>uint32</code> to get the <strong>length</strong> of the message. Then, we read that number of bytes to get the <strong>ID</strong> (the first byte) and the <strong>payload</strong> (the remaining bytes).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=o>//</span><span class=w> </span><span class=k>Read</span><span class=w> </span><span class=n>parses</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>stream</span><span class=p>.</span><span class=w> </span><span class=n>Returns</span><span class=w> </span><span class=o>`</span><span class=n>nil</span><span class=o>`</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>keep</span><span class=o>-</span><span class=n>alive</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=n>func</span><span class=w> </span><span class=k>Read</span><span class=p>(</span><span class=n>r</span><span class=w> </span><span class=n>io</span><span class=p>.</span><span class=n>Reader</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>Message</span><span class=p>,</span><span class=w> </span><span class=n>error</span><span class=p>)</span><span class=w> </span><span class=err>{</span><span class=w> </span><span class=n>lengthBuf</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=nf>make</span><span class=p>([]</span><span class=n>byte</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>io</span><span class=p>.</span><span class=nf>ReadFull</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>lengthBuf</span><span class=p>)</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>nil</span><span class=w> </span><span class=err>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>nil</span><span class=p>,</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=err>}</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=k>binary</span><span class=p>.</span><span class=n>BigEndian</span><span class=p>.</span><span class=nf>Uint32</span><span class=p>(</span><span class=n>lengthBuf</span><span class=p>)</span><span class=w> </span><span class=o>//</span><span class=w> </span><span class=n>keep</span><span class=o>-</span><span class=n>alive</span><span class=w> </span><span class=n>message</span><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=err>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>nil</span><span class=p>,</span><span class=w> </span><span class=n>nil</span><span class=w> </span><span class=err>}</span><span class=w> </span><span class=n>messageBuf</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=nf>make</span><span class=p>([]</span><span class=n>byte</span><span class=p>,</span><span class=w> </span><span class=n>length</span><span class=p>)</span><span class=w> </span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>io</span><span class=p>.</span><span class=nf>ReadFull</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>messageBuf</span><span class=p>)</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>nil</span><span class=w> </span><span class=err>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>nil</span><span class=p>,</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=err>}</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>Message</span><span class=err>{</span><span class=w> </span><span class=n>ID</span><span class=p>:</span><span class=w> </span><span class=nf>messageID</span><span class=p>(</span><span class=n>messageBuf</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span><span class=w> </span><span class=n>Payload</span><span class=p>:</span><span class=w> </span><span class=n>messageBuf</span><span class=p>[</span><span class=mi>1</span><span class=p>:],</span><span class=w> </span><span class=err>}</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=n>nil</span><span class=w> </span><span class=err>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://github.com/veggiedefender/torrent-client/blob/2bde944888e1195e81cc5d5b686f6ec3a9f08c25/message/message.go#L105-L131 target=_blank rel=noopener>view in context</a></p><h3 id=bitfields>Bitfields</h3><p>One of the most interesting types of message is the <strong>bitfield</strong>, which is a data structure that peers use to efficiently encode which pieces they are able to send us. A bitfield looks like a byte array, and to check which pieces they have, we just need to look at the positions of the <em>bits</em> set to 1. You can think of it like the digital equivalent of a coffee shop loyalty card. We start with a blank card of all <code>0</code>, and flip bits to <code>1</code> to mark their positions as “stamped.”</p><p><img src=https://blog.jse.li/torrent/bitfield.png loading=lazy alt="a coffee shop loyalty card with eight slots, with stamps on the first four slots and a stamp on the second to last slot, represented as 11110010"></p><p>By working with <em>bits</em> instead of <em>bytes</em>, this data structure is super compact. We can stuff information about eight pieces in the space of a single byte—the size of a <code>bool</code>. The tradeoff is that accessing values becomes a little more tricky. The smallest unit of memory that computers can address are bytes, so to get to our bits, we have to do some bitwise manipulation:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// A Bitfield represents the pieces that a peer has type Bitfield []byte // HasPiece tells if a bitfield has a particular index set func (bf Bitfield) HasPiece(index int) bool { byteIndex := index / 8 offset := index % 8 return bf[byteIndex]&gt;&gt;(7-offset)&amp;1 != 0 } // SetPiece sets a bit in the bitfield func (bf Bitfield) SetPiece(index int) { byteIndex := index / 8 offset := index % 8 bf[byteIndex] |= 1 &lt;&lt; (7 - offset) }
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://github.com/veggiedefender/torrent-client/blob/2bde944888e1195e81cc5d5b686f6ec3a9f08c25/bitfield/bitfield.go target=_blank rel=noopener>view in context</a></p><h2 id=putting-it-all-together>Putting it all together</h2><p>We now have all the tools we need to download a torrent: we have a list of peers obtained from the tracker, and we can communicate with them by dialing a TCP connection, initiating a handshake, and sending and receiving messages. Our last big problems are handling the <strong>concurrency</strong> involved in talking to multiple peers at once, and managing the <strong>state</strong> of our peers as we interact with them. These are both classically Hard problems.</p><h3 id=managing-concurrency-channels-as-queues>Managing concurrency: channels as queues</h3><p>In Go, we <a class=link href=https://blog.golang.org/share-memory-by-communicating target=_blank rel=noopener>share memory by communicating</a>, and we can think of a Go channel as a cheap thread-safe queue.</p><p>We’ll set up two channels to synchronize our concurrent workers: one for dishing out work (pieces to download) between peers, and another for collecting downloaded pieces. As downloaded pieces come in through the results channel, we can copy them into a buffer to start assembling our complete file.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// Init queues for workers to retrieve work and send results workQueue := make(chan *pieceWork, len(t.PieceHashes)) results := make(chan *pieceResult) for index, hash := range t.PieceHashes { length := t.calculatePieceSize(index) workQueue &lt;- &amp;pieceWork{index, hash, length} } // Start workers for _, peer := range t.Peers { go t.startDownloadWorker(peer, workQueue, results) } // Collect results into a buffer until full buf := make([]byte, t.Length) donePieces := 0 for donePieces &lt; len(t.PieceHashes) { res := &lt;-results begin, end := t.calculateBoundsForPiece(res.index) copy(buf[begin:end], res.buf) donePieces++ } close(workQueue)
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://github.com/veggiedefender/torrent-client/blob/2bde944888e1195e81cc5d5b686f6ec3a9f08c25/p2p/p2p.go#L188-L214 target=_blank rel=noopener>view in context</a></p><p>We’ll spawn a worker goroutine for each peer we’ve received from the tracker. It’ll connect and handshake with the peer, and then start retrieving work from the <code>workQueue</code>, attempting to download it, and sending downloaded pieces back through the <code>results</code> channel.</p><p><img src=https://blog.jse.li/torrent/download.png loading=lazy alt="a flow chart of the download strategy"></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (t *Torrent) startDownloadWorker(peer peers.Peer, workQueue chan *pieceWork, results chan *pieceResult) { c, err := client.New(peer, t.PeerID, t.InfoHash) if err != nil { log.Printf(&#34;Could not handshake with %s. Disconnecting\n&#34;, peer.IP) return } defer c.Conn.Close() log.Printf(&#34;Completed handshake with %s\n&#34;, peer.IP) c.SendUnchoke() c.SendInterested() for pw := range workQueue { if !c.Bitfield.HasPiece(pw.index) { workQueue &lt;- pw // Put piece back on the queue  continue } // Download the piece  buf, err := attemptDownloadPiece(c, pw) if err != nil { log.Println(&#34;Exiting&#34;, err) workQueue &lt;- pw // Put piece back on the queue  return } err = checkIntegrity(pw, buf) if err != nil { log.Printf(&#34;Piece #%d failed integrity check\n&#34;, pw.index) workQueue &lt;- pw // Put piece back on the queue  continue } c.SendHave(pw.index) results &lt;- &amp;pieceResult{pw.index, buf} } }
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://github.com/veggiedefender/torrent-client/blob/2bde944888e1195e81cc5d5b686f6ec3a9f08c25/p2p/p2p.go#L133-L169 target=_blank rel=noopener>view in context</a></p><h3 id=managing-state>Managing state</h3><p>We’ll keep track of each peer in a struct, and modify that struct as we read messages. It’ll include data like how much we’ve downloaded from the peer, how much we’ve requested from them, and whether we’re choked. If we wanted to scale this further, we could formalize this as a finite state machine. But a struct and a switch are good enough for now.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>type pieceProgress struct { index int client *client.Client buf []byte downloaded int requested int backlog int } func (state *pieceProgress) readMessage() error { msg, err := state.client.Read() // this call blocks  switch msg.ID { case message.MsgUnchoke: state.client.Choked = false case message.MsgChoke: state.client.Choked = true case message.MsgHave: index, err := message.ParseHave(msg) state.client.Bitfield.SetPiece(index) case message.MsgPiece: n, err := message.ParsePiece(state.index, state.buf, msg) state.downloaded += n state.backlog-- } return nil }
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://github.com/veggiedefender/torrent-client/blob/2bde944888e1195e81cc5d5b686f6ec3a9f08c25/p2p/p2p.go#L53-L83 target=_blank rel=noopener>view in context</a></p><h3 id=time-to-make-requests>Time to make requests!</h3><p>Files, pieces, and piece hashes aren’t the full story—we can go further by breaking down pieces into <strong>blocks</strong>. A block is a part of a piece, and we can fully define a block by the <strong>index</strong> of the piece it’s part of, its byte <strong>offset</strong> within the piece, and its <strong>length</strong>. When we make requests for data from peers, we are actually requesting <em>blocks</em>. A block is usually 16KB large, meaning that a single 256 KB piece might actually require 16 requests.</p><p>A peer is supposed to sever the connection if they receive a request for a block larger than 16KB. However, based on my experience, they’re often perfectly happy to satisfy requests up to 128KB. I only got moderate gains in overall speed with larger block sizes, so it’s probably better to stick with the spec.</p><h3 id=pipelining>Pipelining</h3><p>Network round-trips are expensive, and requesting each block one by one will absolutely tank the performance of our download. Therefore, it’s important to <strong>pipeline</strong> our requests such that we keep up a constant pressure of some number of unfulfilled requests. This can increase the throughput of our connection by an order of magnitude.</p><p><img src=https://blog.jse.li/torrent/pipelining.png loading=lazy alt="Two email threads simulating peer connections. The thread on the left shows a request followed by a reply, repeated three times. The thread on the left sends three requests, and receives three replies in quick succession."></p><p>Classically, BitTorrent clients kept a queue of five pipelined requests, and that’s the value I’ll be using. I found that increasing it can up to double the speed of a download. Newer clients use an <a class=link href=https://luminarys.com/posts/writing-a-bittorrent-client.html target=_blank rel=noopener>adaptive</a> queue size to better accommodate modern network speeds and conditions. This is definitely a parameter worth tweaking, and it’s pretty low hanging fruit for future performance optimization.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// MaxBlockSize is the largest number of bytes a request can ask for const MaxBlockSize = 16384 // MaxBacklog is the number of unfulfilled requests a client can have in its pipeline const MaxBacklog = 5 func attemptDownloadPiece(c *client.Client, pw *pieceWork) ([]byte, error) { state := pieceProgress{ index: pw.index, client: c, buf: make([]byte, pw.length), } // Setting a deadline helps get unresponsive peers unstuck.  // 30 seconds is more than enough time to download a 262 KB piece  c.Conn.SetDeadline(time.Now().Add(30 * time.Second)) defer c.Conn.SetDeadline(time.Time{}) // Disable the deadline  for state.downloaded &lt; pw.length { // If unchoked, send requests until we have enough unfulfilled requests  if !state.client.Choked { for state.backlog &lt; MaxBacklog &amp;&amp; state.requested &lt; pw.length { blockSize := MaxBlockSize // Last block might be shorter than the typical block  if pw.length-state.requested &lt; blockSize { blockSize = pw.length - state.requested } err := c.SendRequest(pw.index, state.requested, blockSize) if err != nil { return nil, err } state.backlog++ state.requested += blockSize } } err := state.readMessage() if err != nil { return nil, err } } return state.buf, nil }
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://github.com/veggiedefender/torrent-client/blob/2bde944888e1195e81cc5d5b686f6ec3a9f08c25/p2p/p2p.go#L85-L123 target=_blank rel=noopener>view in context</a></p><h3 id=maingo>main.go</h3><p>This is a short one. We’re almost there.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span> <span class=kn>import</span> <span class=p>(</span> <span class=s>&#34;log&#34;</span> <span class=s>&#34;os&#34;</span> <span class=s>&#34;github.com/veggiedefender/torrent-client/torrentfile&#34;</span> <span class=p>)</span> <span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span> <span class=nx>inPath</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=nx>outPath</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=nx>tf</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>torrentfile</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>inPath</span><span class=p>)</span> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>}</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>tf</span><span class=p>.</span><span class=nf>DownloadToFile</span><span class=p>(</span><span class=nx>outPath</span><span class=p>)</span> <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>}</span> <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://github.com/veggiedefender/torrent-client/blob/2bde944888e1195e81cc5d5b686f6ec3a9f08c25/main.go target=_blank rel=noopener>view in context</a></p><h1 id=this-isnt-the-full-story>This isn’t the full story</h1><p>For brevity, I included only a few of the important snippets of code. Notably, I left out all the glue code, parsing, unit tests, and the boring parts that build character. View my <a class=link href=https://github.com/veggiedefender/torrent-client target=_blank rel=noopener>full implementation</a> if you’re interested.</p><p>Thank you for reading.</p><p>from Hacker News <a class=link href=https://ift.tt/35ocCXl target=_blank rel=noopener>https://ift.tt/35ocCXl</a></p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><footer class=site-footer><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3987358164777632" crossorigin=anonymous></script>
<script data-name=BMC-Widget src=https://cdn.buymeacoffee.com/widget/1.0.0/prod/widget.prod.min.js data-id=0x000216 data-description=coffee! data-message=coffee! data-color=#FF813F data-position=right data-x_margin=28 data-y_margin=18></script></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#parsing-a-torrent-file>Parsing a .torrent file</a></li><li><a href=#retrieving-peers-from-the-tracker>Retrieving peers from the tracker</a></li><li><a href=#parsing-the-tracker-response>Parsing the tracker response</a></li></ol><ol><li><a href=#start-a-tcp-connection>Start a TCP connection</a></li><li><a href=#complete-the-handshake>Complete the handshake</a></li><li><a href=#send-and-receive-messages>Send and receive messages</a><ol><li><a href=#interpreting-messages>Interpreting messages</a></li><li><a href=#bitfields>Bitfields</a></li></ol></li><li><a href=#putting-it-all-together>Putting it all together</a><ol><li><a href=#managing-concurrency-channels-as-queues>Managing concurrency: channels as queues</a></li><li><a href=#managing-state>Managing state</a></li><li><a href=#time-to-make-requests>Time to make requests!</a></li><li><a href=#pipelining>Pipelining</a></li><li><a href=#maingo>main.go</a></li></ol></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>