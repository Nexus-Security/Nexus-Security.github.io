<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Posted on 2019-09-26 by Oleg Grenrus
These are notes of the talk I gave at ClojuTre 2019. There should be a video recording of the talk, I&amp;rsquo;ll add a link here. There&amp;rsquo;s the slide deck as PDF too.
This work is licensed under a ‚ÄúCC BY SA 4.0‚Äù license.
Hello ClojuTre. I&amp;rsquo;m Oleg from Helsinki.
Imagine you are writing a cool new rogue-like game. So cool many have no idea what&amp;rsquo;s going on."><title>Do you have a problem? Write a compiler</title><link rel=canonical href=https://Nexus-Security.github.io/posts/2016-09-09-do-you-have-problem-write-compiler/><link rel=stylesheet href=/scss/style.min.450926226e724574a6b936335ea06111f8aeb253d932c86cb2cc807341cd2889.css><meta property="og:title" content="Do you have a problem? Write a compiler"><meta property="og:description" content="Posted on 2019-09-26 by Oleg Grenrus
These are notes of the talk I gave at ClojuTre 2019. There should be a video recording of the talk, I&amp;rsquo;ll add a link here. There&amp;rsquo;s the slide deck as PDF too.
This work is licensed under a ‚ÄúCC BY SA 4.0‚Äù license.
Hello ClojuTre. I&amp;rsquo;m Oleg from Helsinki.
Imagine you are writing a cool new rogue-like game. So cool many have no idea what&amp;rsquo;s going on."><meta property="og:url" content="https://Nexus-Security.github.io/posts/2016-09-09-do-you-have-problem-write-compiler/"><meta property="og:site_name" content="ZYChimne"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:published_time" content="2019-10-03T04:56:00+01:00"><meta property="article:modified_time" content="2019-10-03T04:56:00+01:00"><meta name=twitter:title content="Do you have a problem? Write a compiler"><meta name=twitter:description content="Posted on 2019-09-26 by Oleg Grenrus
These are notes of the talk I gave at ClojuTre 2019. There should be a video recording of the talk, I&amp;rsquo;ll add a link here. There&amp;rsquo;s the slide deck as PDF too.
This work is licensed under a ‚ÄúCC BY SA 4.0‚Äù license.
Hello ClojuTre. I&amp;rsquo;m Oleg from Helsinki.
Imagine you are writing a cool new rogue-like game. So cool many have no idea what&amp;rsquo;s going on."></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu8b78332b6420dc9affabe23720d11e63_1937019_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>üçá</span></figure><div class=site-meta><h1 class=site-name><a href=/>ZYChimne</a></h1><h2 class=site-description>Computer Science, Wuhan University</h2></div></header><ol class=social-menu><li><a href=https://github.com/ZYChimne target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/ZChimne target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about-me/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About Me</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/posts/2016-09-09-do-you-have-problem-write-compiler/>Do you have a problem? Write a compiler</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Oct 03, 2019</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>7 minute read</time></div></footer></div></header><section class=article-content><p>Posted on 2019-09-26 by Oleg Grenrus</p><p>These are notes of the talk I gave at <a class=link href=https://clojutre.org/2019/ target=_blank rel=noopener>ClojuTre 2019</a>. There should be a video recording of the talk, I&rsquo;ll add a link here. There&rsquo;s <a class=link href=https://oleg.fi/pdfs/write-a-compiler.pdf target=_blank rel=noopener>the slide deck as PDF too</a>.</p><p><a class=link href=https://creativecommons.org/licenses/by-sa/2.0/ target=_blank rel=noopener><img src=http://oleg.fi/gists/images/by-sa.svg loading=lazy> This work is licensed under a ‚ÄúCC BY SA 4.0‚Äù license.</a></p><p>Hello ClojuTre. I&rsquo;m Oleg from Helsinki.</p><hr><p>Imagine you are writing a cool new rogue-like game. So cool many have no idea what&rsquo;s going on. A definitive character of rogue-likes is procedural generation of content. You&rsquo;ll need a random number generator for that.</p><hr><p>SplitMix is a fast, splittable pseudorandom number generator. Being able to split a generator into two independent generators is a property you&rsquo;ll want if you use the generator in a functional programming language. Look it up. We&rsquo;ll concentrate on the being fast part. Obviously you want things to be fast.</p><p>SplitMix is fast. It does only 9 operations per generated number, one addition to advance the random seed, and <code>xor</code>, <code>shift</code>, <code>multiply</code> <code>xor</code>, <code>shift</code>, <code>multiply</code>, <code>xor</code> and <code>shift</code>. 9 in total.</p><p>However, for the maximum reach, we want our game to run in the web browsers.</p><hr><ul><li>JavaScript is a great platform</li><li>But a terrible programming language</li></ul><hr><p>Look carefully. When we multiply two &ldquo;big&rdquo; odd numbers, we do get even result. We shouldn&rsquo;t: product of two odd numbers is odd.</p><p>JavaScript numbers are a mess. Next a bit of arithmetics.</p><hr><p>Instead of multiplying two big numbers, we split them in high and low parts and multiply many small numbers. Like in an elementary school. Then we&rsquo;ll have enough precision.</p><hr><p>So as we are multiplying 32bit numbers, and are interested only in lower 32 bits of 64 bit result. Then we need to do only three multiplications.</p><p>At the end, we can get correct results, i.e. good random numbers even in JavaScript.</p><hr><p>Next if we replace the multiplication in <code>xor-shift-multiply</code> with a macro doing the right thing, and actually change everything to be a macro, and expand we&rsquo;ll get&mldr;</p><hr><p>a lot of code which barely fits on the slide.</p><p>I had to shorted <code>bit-shift-left</code> to <code>bsl</code> and <code>unsigned-bit-shift-right</code> to <code>ubsr</code>.</p><hr><p>Look closely. Would you write this kind of code.</p><hr><p>We bind (&ldquo;assign&rdquo;) a constant value to <code>uv</code> variable.</p><hr><p>And the calculate the high and low 16 bit parts of it. Something we could write directly: <code>let [u 0x85eb v ca6b]</code>, i.e. <em>optimize by hand</em>. Should we do so?</p><hr><p>No. Let&rsquo;s rather write an (optimizing) compiler. We don&rsquo;t have time to optimize by hand.</p><hr><p>Recall, we have a very specific problem. Working with a very very tiny subset of Clojure. Some simple arithmetic and bit mangling of 32bit numbers.</p><hr><p>We&rsquo;d like to add a little of <code>magic</code>, which would make the program magically run faster. In my toy-micro benchmarks the speed-up is 10 percent. It&rsquo;s definitely worth it.</p><hr><p>What is this magic?</p><hr><p>A little cute macro. Of course.</p><hr><p>We get a <code>form</code> and convert it into internal representation on a way in, and back to Clojure on the way back.</p><p>Working the whole Clojure syntax directly is insane task. We want only deal with a small sane subset of it. Also in a easier to manipulate format. Clojure as a pragmatic language is still optimized for writing and reading, not machine manipulation so much.</p><hr><p>The next step is to expand a multiplication using a trick we have seen previously. We could have done it already in <code>from-clojure</code> step, but it&rsquo;s good engineering to have only one thing per step.</p><hr><p>And the important part is the <code>optimise</code> function.</p><hr><p>The internal representation I used is nested vectors with a node type as a first element. An uniform representation made it way easier to do everything else. Note how literals 1 and 3 are wrapped into vector too. We can simply look at the head of a vector to know what we are dealing with.</p><p>Code is Data.</p><hr><p>A difficult part in <em>Code is Data</em> are local variables. I chose to use <em>de Bruijn</em> indices, so instead of names: <code>x</code> and <code>y</code> or <code>a</code> and <code>b</code> there are numbers counting towards the corresponding <code>let</code> (which binds only one variable at the time by the way).</p><p>de Bruijn indices are tricky to grok. Look at the colors, they are there to help. The blue <code>:var 1</code> references &ldquo;one away&rdquo; <code>let</code>.</p><p>I don&rsquo;t expect you to understand them. It&rsquo;s one way to represent bindings. Perfectly there should be a library, so you don&rsquo;t need to think about low-level details.</p><hr><p>Once we got rid out of names, we can still keep them around using metadata. That&rsquo;s a really cool feature in Clojure, I have to admit. The metadata is there, but not in your way. And having names around is actually useful when you try to debug things.</p><hr><p>Now we have a setup done. Let&rsquo;s jump into optimizations.</p><hr><p>Recall our code snippet. There&rsquo;s <code>uv</code> which is bound to a constant. And then it&rsquo;s used an expression which could simplify if we do this and that&mldr;</p><hr><p>Let&rsquo;s keep it super simple.</p><ul><li>We can have a small set of simple local rewrite rules. Local meaning, we don&rsquo;t need to look around, only at one subexpression at the time.</li><li>Then we try to match the rule everywhere, and if it match, perform the rewrite.</li><li>And loop until there&rsquo;s nothing to do.</li></ul><hr><p>The first optimization is inlining. In a sense it&rsquo;s most powerful one, as it makes opportunities for other optimizations to fire, even that on itself it doesn&rsquo;t do much.</p><p>So if we have a let-binding, then in some cases we perform a substitution. Replace all <code>x</code>s with an <code>expression</code> inside a body.</p><p><code>let x 1 y 1 (+ x y)</code> to a lot simpler <code>(+ 1 2)</code>. But nothing more, just that.</p><hr><p>I need to point out, that optimizing is somewhat of an art. Sometimes it work, sometimes it don&rsquo;t.</p><p>For example, we don&rsquo;t want to duplicate an expensive <code>(fibonacci 100)</code> expression. We want to evaluate it once and share the result.</p><p>On the other hand, if someone already went and computed the value, then we can push it to the leaves of an expression tree.</p><p>Heuristics are tricky.</p><p>Luckily for our needs simple heuristics work well.</p><hr><p>When <em>inlining</em> is a valid rewrite?</p><hr><p>Not in every language. Consider this not-so-functional example.</p><p>If we substitute everything, the <code>(do-foo)</code> and <code>(do-bar)</code> would be in different order. And <code>(do-quux)</code> will be gone completely, hopefully it didn&rsquo;t anything important!</p><p>We need a language where there are no side-effects, nor there are so much difference in the execution order. Whole Clojure isn&rsquo;t such language. Our tiny subset is.</p><p>I have heard there are programming languages which behave like our small one, but are more general purpose!</p><p>OK. Let&rsquo;s move to the next optimization.</p><hr><p>When we have something simple as <code>(+ 1 2)</code>, let us evaluate it already at compile time.</p><p>For every primitive operation, if the arguments are known constants, just do it.</p><hr><p>Now, I ask you when <em>constant folding</em> is a valid rewrite.</p><hr><p>Well, that was a trick question. It really depends on primitives, whether it make sense to perform them at compile time. (Even pure languages have primitives to print stuff on a screen).</p><p>But you could think about that <code>precalculate</code> example. When does it makes to perform the calculation (assuming we somehow know it terminates):</p><ul><li>At compile time?</li><li>At start up?</li><li>At first access?</li></ul><p>It really depends, and there are no single simple answer.</p><p>Again, optimizations is an art.</p><hr><p>Because we work with nice internal representation, writing individual optimizations is so nice.</p><ul><li>if a node is not one of special nodes</li><li>and all node arguments are constants</li><li>evaluate it.</li></ul><p>The code is shorter than my explanation. And still understandable.</p><hr><p>With these two optimizations, inlining and constant folding, we get from this big (and repetitive) code blob to&mldr;</p><hr><p>Something which actually fits on the slide without font size scaling. It&rsquo;s not super-pretty, but it&rsquo;s hard to spot if something can be done there.</p><hr><p>We can make it look nice with one more optimization. When you bind a let-expression to a variable in outer let-expression, we can float out the inner one.</p><p>A very old idea it is.</p><hr><p>And then we get (in my opinion) a very nice direct code. Six intermediate results to get final one.</p><hr><p>That&rsquo;s what I wanted to tell you.</p><hr><ul><li>Implementing small (domain specific) languages is fun.</li><li>If you approach problems with &ldquo;let&rsquo;s write a programming language to describe them&rdquo; -attitude there a lot of big hammers in your disposal. A lot of wheels is already invented.</li><li>Languages don&rsquo;t need only be about numerics, it could be HTTP routing, authorisation rules, UI-workflows, CI-scripts (I could bash about bash), data descriptions, you name it.</li><li>But make your languages <em>typed, lazy, pure, total or and even dependent</em> for extra fun and interesting new problems. ;)</li></ul><p>Thank you.</p><p>from Hacker News <a class=link href=https://ift.tt/2nvy1xO target=_blank rel=noopener>https://ift.tt/2nvy1xO</a></p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2020 -
2022 ZYChimne</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>