<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Applying deep learning to Airbnb search Haldar et al., KDD‚Äô19
Last time out we looked at Booking.com‚Äôs lessons learned from introducing machine learning to their product stack. Today‚Äôs paper takes a look at what happened in Airbnb when they moved from standard machine learning approaches to deep learning. It‚Äôs written in a very approachable style and packed with great insights. I hope you enjoy it as much as I did!"><title>Applying deep learning to Airbnb search</title><link rel=canonical href=https://Nexus-Security.github.io/posts/2016-09-09-applying-deep-learning-to-airbnb-search/><link rel=stylesheet href=/scss/style.min.450926226e724574a6b936335ea06111f8aeb253d932c86cb2cc807341cd2889.css><meta property="og:title" content="Applying deep learning to Airbnb search"><meta property="og:description" content="Applying deep learning to Airbnb search Haldar et al., KDD‚Äô19
Last time out we looked at Booking.com‚Äôs lessons learned from introducing machine learning to their product stack. Today‚Äôs paper takes a look at what happened in Airbnb when they moved from standard machine learning approaches to deep learning. It‚Äôs written in a very approachable style and packed with great insights. I hope you enjoy it as much as I did!"><meta property="og:url" content="https://Nexus-Security.github.io/posts/2016-09-09-applying-deep-learning-to-airbnb-search/"><meta property="og:site_name" content="ZYChimne"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:published_time" content="2019-10-09T09:27:00+01:00"><meta property="article:modified_time" content="2019-10-09T09:27:00+01:00"><meta name=twitter:title content="Applying deep learning to Airbnb search"><meta name=twitter:description content="Applying deep learning to Airbnb search Haldar et al., KDD‚Äô19
Last time out we looked at Booking.com‚Äôs lessons learned from introducing machine learning to their product stack. Today‚Äôs paper takes a look at what happened in Airbnb when they moved from standard machine learning approaches to deep learning. It‚Äôs written in a very approachable style and packed with great insights. I hope you enjoy it as much as I did!"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu8b78332b6420dc9affabe23720d11e63_1937019_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>üçá</span></figure><div class=site-meta><h1 class=site-name><a href=/>ZYChimne</a></h1><h2 class=site-description>Computer Science, Wuhan University</h2></div></header><ol class=social-menu><li><a href=https://github.com/ZYChimne target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/ZChimne target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about-me/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About Me</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/posts/2016-09-09-applying-deep-learning-to-airbnb-search/>Applying deep learning to Airbnb search</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Oct 09, 2019</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>7 minute read</time></div></footer></div></header><section class=article-content><p><a class=link href=https://arxiv.org/abs/1810.09591 target=_blank rel=noopener>Applying deep learning to Airbnb search</a> Haldar et al., <em>KDD‚Äô19</em></p><p>Last time out we looked at Booking.com‚Äôs lessons learned from introducing machine learning to their product stack. Today‚Äôs paper takes a look at what happened in Airbnb when they moved from standard machine learning approaches to deep learning. It‚Äôs written in a very approachable style and packed with great insights. I hope you enjoy it as much as I did!</p><blockquote><p>Ours is a story of the elements we found useful in applying neural networks to a real life product. Deep learning was steep learning for us. To other teams embarking on similar journeys, we hope an account of our struggles and triumphs will provide some useful pointers.</p></blockquote><h3 id=an-ecosystem-of-models>An ecosystem of models</h3><p>The core application of machine learning discussed in this paper is the model which orders available listings according to a guest‚Äôs likelihood of booking. This is one of a whole ecosystem of models which contribute towards search rankings when a user searches on Airbnb. New models are tested online through an A/B testing framework to compare their performance to previous generations.</p><h3 id=the-time-is-right>The time is right</h3><p>The very first version of search ranking at Airbnb was a hand-written function.</p><blockquote><p>Replacing the manual scoring function with a gradient boosted decision tree (GBDT) model gave one of the largest step improvements in homes bookings in Airbnb‚Äôs history.</p></blockquote><p>There were many successful iterations of that approach to follow, but eventually performance saturated and it was hard to make any further improvements. ‚Äú<em>This made the moment ripe for trying sweeping changes to the system</em>.‚Äù</p><h3 id=you-need-to-be-this-tall>You need to be this tall</h3><p>Note that the Airbnb team already had experience with machine learning, data pipelines in place, and an online controlled experiment platform available. From this foundation, they took their first steps towards neural networks.</p><blockquote><p>For teams started to explore machine learning, we would recommend a look at ‚Äò<a class=link href=https://developers.google.com/machine-learning/guides/rules-of-ml/ target=_blank rel=noopener>Rules of machine learning</a>‚Äô as well.</p></blockquote><h3 id=is-it-worth-it>Is it worth it?</h3><p>Airbnb moved from their starting point with a Gradient Boosted Decision Tree (GBDT) model towards deep neural networks in stages. Overall, the transition was ‚Äú<em>one of the most impactful applications of machine learning at Airbnb</em>.‚Äù The charts below show the improvements over time in the key offline metric, normalised discounted cumulative gain (NDCG), and in gains in bookings achieved online with the deployed models.</p><p><img src="https://adriancolyer.files.wordpress.com/2019/10/airbnb-dnn-fig-2.jpeg?w=480" loading=lazy></p><p>Of course this version of the truth edits out of all the detours and failed attempts along the way: ‚Äú<em>Reality is studded with unsuccessful attempts that outnumber the successful ones‚Ä¶</em>‚Äù</p><h3 id=dont-be-a-hero>Don‚Äôt be a hero</h3><blockquote><p>Andrej Karpathy has advice regarding model architecture: don‚Äôt be a hero. Well, that‚Äôs not how we started‚Ä¶</p></blockquote><p>But after a few aborted attempts, the first neural network model deployed to production was a simple one with a single hidden layer with 32 fully-connected ReUL activations. It proved neutral on booking performance when compared with the previous GBDT model. It wasn‚Äôt a wasted exercise though:</p><blockquote><p>The value of the whole exercise was that it validated that the entire NN pipeline was production ready and capable of serving live traffic.</p></blockquote><h3 id=dont-be-a-hero-in-the-beginning>Don‚Äôt be a hero, in the beginning</h3><blockquote><p>Not being a hero got us off to a start, but not very far. In time we would adapt Kapathy‚Äôs advice to: don‚Äôt be a hero, in the beginning.</p></blockquote><p>The first big breakthrough in booking gains came by combining the NN with ideas from <a class=link href=https://www.microsoft.com/en-us/research/publication/from-ranknet-to-lambdarank-to-lambdamart-an-overview/ target=_blank rel=noopener>Lambdarank</a>. Whereas the original NN used the same features as the GDBT model, ‚Äú<em>Lambdarank gave us a way to directly optimize the NN for NDCG</em>.‚Äù</p><p>The Lambdarank model used pairs of {booked, not-booked} examples as inputs to training, and weighed each pairwise loss by the difference in NDCG resulting from swapping the ordering in the pair. The end result was that booked listing tended to move towards the top of the search results.</p><h3 id=lets-use-all-the-things>Let‚Äôs use all the things</h3><p>The success path documented in this paper is based on neural network models, but there were other models under investigation as well. These gave similar end performance in some cases, but the listings that they up-ranked were quite different. So the next iteration tried to combine the strengths of the NN approach with features from the GBDT model and a factorization machine model as additional inputs.</p><p><img src="https://adriancolyer.files.wordpress.com/2019/10/airbnb-dnn-fig-3.jpeg?w=480" loading=lazy></p><p>It did give a boost in bookings, but at a cost.</p><blockquote><p>The complexity of the model at this point was staggering, and some of the issues mentioned in ‚Äò<a class=link href=https://developers.google.com/machine-learning/guides/rules-of-ml/ target=_blank rel=noopener>Hidden technical debt in machine learning</a>‚Äô began to rear their heads.</p></blockquote><p>(See also the related ‚Äò<a class=link href=https://blog.acolyer.org/2016/02/29/machine-learning-the-high-interest-credit-card-of-technical-debt/ target=_blank rel=noopener>Machine Learning: the high-interest credit card of technical debt</a>‚Äô.)</p><h3 id=dump-the-complexity>Dump the complexity</h3><blockquote><p>In our final leap, we were able to deprecate all that complexity by simply scaling the training data 10x and moving to a DNN with 2 hidden layers.</p></blockquote><p>(So not <em>that</em> deep really!)</p><p>But it was comparatively wide compared to the first versions: an input layer with 195 features, feeding a first hidden layer with 127 fully connected ReLUs and a second hidden layer with 83 fully connected ReLUs.</p><h3 id=feeding-the-model>Feeding the model</h3><p>Running alongside the evolution in model architectures there was a corresponding evolution in the features fed into those models.</p><blockquote><p>In our very first attempt at training a NN, we simply took all the features used to train the GBDT model and fed it to the NN. This went down very badly.</p></blockquote><p>The first improvement came from applying feature normalisation (GDBTs aren‚Äôt especially sensitive to exact numeric values, but NNs are). This mapped features into a small range of values largely in {-1,1} with the median at 0.</p><p>The next big improvement came from ensuring that the distributions of these features were <em>smooth</em>. Striving for smooth distributions helped with spotting bugs, encouraging generalisation, highlighting areas where a little more feature engineering would be useful, and uncovering additional features a model may be missing.</p><blockquote><p>Answering exactly why DNNs are good at generalizing is a complicated topic at the forefront of research. Meanwhile, our working knowledge is based on the observation that in the DNNs built for our application, the outputs of the layers get progressively smoother in terms of their distributions‚Ä¶ The smooth distributions coming from the lower layers ensure that the upper layers can correctly ‚Äòinterpolate‚Äô the behavior for unseen values. Extending this intuition all the way to the input layer, we put our best effort to ensure the input features have a smooth distribution.</p></blockquote><p><img src="https://adriancolyer.files.wordpress.com/2019/10/airbnb-dnn-fig-8-10.jpeg?w=480" loading=lazy></p><h3 id=tuning-the-model>Tuning the model</h3><p>Neural networks bring with them a large hyperparameter space to explore. In the end, simple worked best at Airbnb.</p><blockquote><p>For our application, we found it hard to improve upon the performance of Adam with its default settings‚Ä¶ Having swept the learning rate issue under the LazyAdamOptimizer carpet, we just opted for a fixed batch size of 200 which seemed to work for the current models.</p></blockquote><h3 id=understanding-the-model>Understanding the model</h3><p>One of things that became harder with the move to NNs was understanding what the model was actually doing and why. After trying a variety of tactics, thing that worked best for Airbnb was a home-grown tool called <em>TopBot</em>, a top-bottom analyser. TopBot compares distribution plots of feature values from listings ranked highly to the distribution plots of feature values from listing ranked at the bottom. This comparison highlights how the model is utilising features in the different value ranges.</p><p>For example, the plots below show the sensitivity of the model to price, but also reveal that this version of the model was not utilising reviews as expected.</p><p><img src="https://adriancolyer.files.wordpress.com/2019/10/airbnb-dnn-fig-14.jpeg?w=480" loading=lazy></p><h3 id=benefits-and-learnings>Benefits and learnings</h3><p>Moving to deep learning is about more than just changing the internals of your model, it‚Äôs also a change of <em>scale</em>. ‚Äú<em>As a result, it required rethinking the entire system surrounding the model</em>.‚Äù</p><blockquote><p>So would we recommend deep learning to others? That would be a wholehearted Yes. And it‚Äôs not only because of the strong gains in the online performance of the model. Part of it has to do with how deep learning has transformed our roadmap ahead. Earlier the focus was largely on feature engineering, but after the move to deep learning, trying to do better math on the features manually has lost its luster. This has freed us up to investigate problems at a higher level, like how can we improve our optimization objective, and are we accurately representing all our users?</p></blockquote><p>Two years in, the team at Airbnb are just getting started‚Ä¶</p><p>from Hacker News <a class=link href=https://ift.tt/2IAYCkz target=_blank rel=noopener>https://ift.tt/2IAYCkz</a></p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2020 -
2022 ZYChimne</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><ol><li><a href=#an-ecosystem-of-models>An ecosystem of models</a></li><li><a href=#the-time-is-right>The time is right</a></li><li><a href=#you-need-to-be-this-tall>You need to be this tall</a></li><li><a href=#is-it-worth-it>Is it worth it?</a></li><li><a href=#dont-be-a-hero>Don‚Äôt be a hero</a></li><li><a href=#dont-be-a-hero-in-the-beginning>Don‚Äôt be a hero, in the beginning</a></li><li><a href=#lets-use-all-the-things>Let‚Äôs use all the things</a></li><li><a href=#dump-the-complexity>Dump the complexity</a></li><li><a href=#feeding-the-model>Feeding the model</a></li><li><a href=#tuning-the-model>Tuning the model</a></li><li><a href=#understanding-the-model>Understanding the model</a></li><li><a href=#benefits-and-learnings>Benefits and learnings</a></li></ol></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>