<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="arduino-copilot, released today, makes it easy to use Haskell to program an Arduino. It&amp;rsquo;s a FRP style system, and uses the Copilot DSL to generate embedded C code.
gotta blink before you can run To make your arduino blink its LED, you only need 4 lines of Haskell:
1 import Copilot.Arduino main = arduino $ do led =: blinking delay =: constant 100 Running that Haskell program generates an Arduino sketch in an ."><title>Announcing Arduino-Copilot</title><link rel=canonical href=https://Nexus-Security.github.io/posts/2016-09-09-announcing-arduino-copilot/><link rel=stylesheet href=/scss/style.min.450926226e724574a6b936335ea06111f8aeb253d932c86cb2cc807341cd2889.css><meta property="og:title" content="Announcing Arduino-Copilot"><meta property="og:description" content="arduino-copilot, released today, makes it easy to use Haskell to program an Arduino. It&amp;rsquo;s a FRP style system, and uses the Copilot DSL to generate embedded C code.
gotta blink before you can run To make your arduino blink its LED, you only need 4 lines of Haskell:
1 import Copilot.Arduino main = arduino $ do led =: blinking delay =: constant 100 Running that Haskell program generates an Arduino sketch in an ."><meta property="og:url" content="https://Nexus-Security.github.io/posts/2016-09-09-announcing-arduino-copilot/"><meta property="og:site_name" content="ZYChimne"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:published_time" content="2020-01-26T01:42:00+01:00"><meta property="article:modified_time" content="2020-01-26T01:42:00+01:00"><meta name=twitter:title content="Announcing Arduino-Copilot"><meta name=twitter:description content="arduino-copilot, released today, makes it easy to use Haskell to program an Arduino. It&amp;rsquo;s a FRP style system, and uses the Copilot DSL to generate embedded C code.
gotta blink before you can run To make your arduino blink its LED, you only need 4 lines of Haskell:
1 import Copilot.Arduino main = arduino $ do led =: blinking delay =: constant 100 Running that Haskell program generates an Arduino sketch in an ."></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue825486955cd7c56d95e38b4bd2a8e3c_229979_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>ZYChimne</a></h1><h2 class=site-description>Computer Science, Wuhan University</h2></div></header><ol class=social-menu><li><a href=https://github.com/ZYChimne target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/ZChimne target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about-me/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About Me</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/posts/2016-09-09-announcing-arduino-copilot/>Announcing Arduino-Copilot</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jan 26, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><p><a class=link href=https://hackage.haskell.org/package/arduino-copilot target=_blank rel=noopener>arduino-copilot</a>, released today, makes it easy to use Haskell to program an Arduino. It&rsquo;s a FRP style system, and uses the <a class=link href=https://copilot-language.github.io/ target=_blank rel=noopener>Copilot</a> DSL to generate embedded C code.</p><h2 id=gotta-blink-before-you-can-run>gotta blink before you can run</h2><p>To make your arduino blink its LED, you only need 4 lines of Haskell:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>import Copilot.Arduino main = arduino $ do led =: blinking delay =: constant 100 
</span></span></code></pre></td></tr></table></div></div><p>Running that Haskell program generates an Arduino sketch in an <code>.ino</code> file, which can be loaded into the Arduino IDE and uploaded to the Arduino the same as any other sketch. It&rsquo;s also easy to use things like <code>Arduino-Makefile</code> to build and upload sketches generated by arduino-copilot.</p><h2 id=shoulders-of-giants>shoulders of giants</h2><p>Copilot is quite an impressive embedding of C in Haskell. It was developed for NASA by Galois and is intended for safety-critical applications. So it&rsquo;s neat to be able to repurpose it into hobbyist microcontrollers. (I do hope to get more type safety added to Copilot though, currently it seems rather easy to confuse eg miles with kilometers when using it.)</p><p>I&rsquo;m not the first person to use Copilot to program an Arduino. Anthony Cowley showed how to do it in <a class=link href=https://vimeo.com/77164337 target=_blank rel=noopener>Abstractions for the Functional Roboticist</a> back in 2013. But he had to write a skeleton of C code around the C generated by Copilot. Amoung other features, arduino-copilot automates generating that C skeleton. So you don&rsquo;t need to remember to enable GPIO pin 13 for output in the setup function; arduino-copilot sees you&rsquo;re using the LED and does that for you.</p><p><a class=link href=http://hackage.haskell.org/package/frp-arduino target=_blank rel=noopener>frp-arduino</a> was a big inspiration too, especially how easy it makes it to generate an Arduino sketch withough writing any C. The &ldquo;<code>=:</code>&rdquo; operator in copilot-arduino is copied from it. But ftp-arduino contains its own DSL, which seems less capable than Copilot. And when I looked at using frp-arduino for some real world sensing and control, it didn&rsquo;t seem to be possible to integrate it with existing Arduino libraries written in C. While I&rsquo;ve not done that with arduino-copilot yet, I did design it so it should be reasonably easy to integrate it with any Arduino library.</p><h2 id=a-more-interesting-example>a more interesting example</h2><p>Let&rsquo;s do something more interesting than flashing a LED. We&rsquo;ll assume pin 12 of an Arduino Uno is connected to a push button. When the button is pressed, the LED should stay lit. Otherwise, flash the LED, starting out flashing it fast, but flashing slower and slower over time, and then back to fast flashing.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>{-# LANGUAGE RebindableSyntax #-} import Copilot.Arduino.Uno main :: IO () main = arduino $ do buttonpressed &lt;- readfrom pin12 led =: buttonpressed || blinking delay =: longer_and_longer * 2 
</span></span></code></pre></td></tr></table></div></div><p>This is starting to use features of the Copilot DSL; &ldquo;<code>buttonpressed || blinking</code>&rdquo; combines two FRP streams together, and &ldquo;<code>longer_and_longer * 2</code>&rdquo; does math on a stream. What a concise and readable implementation of this Arduino&rsquo;s behavior!</p><p>Finishing up the demo program is the implementation of <code>longer_and_longer</code>. This part is entirely in the Copilot DSL, and actually I lifted it from some Copilot example code. It gives a reasonable flavor of what it&rsquo;s like to construct streams in Copilot.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=n>longer_and_longer</span><span class=w> </span><span class=p>::</span><span class=w> </span><span class=n>Stream</span><span class=w> </span><span class=n>Int16</span><span class=w> </span><span class=n>longer_and_longer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=no>true</span><span class=w> </span><span class=err>$</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=no>true</span><span class=w> </span><span class=no>false</span><span class=w> </span><span class=o>`</span><span class=k>mod</span><span class=o>`</span><span class=w> </span><span class=mi>64</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=p>::</span><span class=w> </span><span class=n>Stream</span><span class=w> </span><span class=kt>Bool</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>Stream</span><span class=w> </span><span class=kt>Bool</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>Stream</span><span class=w> </span><span class=n>Int16</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=n>inc</span><span class=w> </span><span class=n>reset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cnt</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>cnt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>reset</span><span class=w> </span><span class=k>then</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>inc</span><span class=w> </span><span class=k>then</span><span class=w> </span><span class=n>z</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=n>z</span><span class=w> </span><span class=n>z</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>++</span><span class=w> </span><span class=n>cnt</span><span class=w> 
</span></span></span></code></pre></td></tr></table></div></div><p>This whole example turns into just 63 lines of C code, which compiles to a 1248 byte binary, so there&rsquo;s plenty of room left for larger, more complex programs.</p><h2 id=simulating-an-arduino>simulating an Arduino</h2><p>One of Copilot&rsquo;s features is it can interpret code, without needing to run it on the target platform. So the Arduino&rsquo;s behavior can be simulated, without ever generating C code, right at the console!</p><p>But first, one line of code needs to be changed, to provide some button states for the simulation:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> buttonpressed &lt;- readfrom&#39; pin12 [False, False, False, True, True] 
</span></span></code></pre></td></tr></table></div></div><p>Now let&rsquo;s see what it does:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># runghc demo.hs -i 5 delay: digitalWrite: (2) (13,false) (4) (13,true) (8) (13,false) (16) (13,true) (32) (13,true) 
</span></span></code></pre></td></tr></table></div></div><p>Which is exactly what I described it doing! To prove that it always behaves correctly, you could use <a class=link href=https://hackage.haskell.org/package/copilot-theorem target=_blank rel=noopener>copilot-theorem</a>.</p><hr><p>Development of arduino-copilot was sponsored by Trenton Cronholm and Jake Vosloo <a class=link href=https://patreon.com/joeyh target=_blank rel=noopener>on Patreon</a>.</p><p>from Hacker News <a class=link href=https://ift.tt/30UNQh0 target=_blank rel=noopener>https://ift.tt/30UNQh0</a></p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2020 -
2022 ZYChimne</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#gotta-blink-before-you-can-run>gotta blink before you can run</a></li><li><a href=#shoulders-of-giants>shoulders of giants</a></li><li><a href=#a-more-interesting-example>a more interesting example</a></li><li><a href=#simulating-an-arduino>simulating an Arduino</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>