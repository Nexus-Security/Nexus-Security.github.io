<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="It‚Äôs been too long since I last did a good hack, for no practical reason other than great hack value. In my case, these often amount to a nostalgia for an age of computing I wasn‚Äôt present for. In a recent bid to capture more of this nostalgia, I recently picked up a dot matrix line printer, specifically the Epson LX-350 printer. This one is nice because it has a USB port, so I don‚Äôt have to break out my pile of serial cable hacks to get it talking to Linux üòÅ"><title>An old-school shell hack on a line printer</title><link rel=canonical href=https://Nexus-Security.github.io/posts/2016-09-09-an-old-school-shell-hack-on-line-printer/><link rel=stylesheet href=/scss/style.min.450926226e724574a6b936335ea06111f8aeb253d932c86cb2cc807341cd2889.css><meta property="og:title" content="An old-school shell hack on a line printer"><meta property="og:description" content="It‚Äôs been too long since I last did a good hack, for no practical reason other than great hack value. In my case, these often amount to a nostalgia for an age of computing I wasn‚Äôt present for. In a recent bid to capture more of this nostalgia, I recently picked up a dot matrix line printer, specifically the Epson LX-350 printer. This one is nice because it has a USB port, so I don‚Äôt have to break out my pile of serial cable hacks to get it talking to Linux üòÅ"><meta property="og:url" content="https://Nexus-Security.github.io/posts/2016-09-09-an-old-school-shell-hack-on-line-printer/"><meta property="og:site_name" content="ZYChimne"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:published_time" content="2019-11-11T05:01:00+01:00"><meta property="article:modified_time" content="2019-11-11T05:01:00+01:00"><meta name=twitter:title content="An old-school shell hack on a line printer"><meta name=twitter:description content="It‚Äôs been too long since I last did a good hack, for no practical reason other than great hack value. In my case, these often amount to a nostalgia for an age of computing I wasn‚Äôt present for. In a recent bid to capture more of this nostalgia, I recently picked up a dot matrix line printer, specifically the Epson LX-350 printer. This one is nice because it has a USB port, so I don‚Äôt have to break out my pile of serial cable hacks to get it talking to Linux üòÅ"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue825486955cd7c56d95e38b4bd2a8e3c_229979_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>ZYChimne</a></h1><h2 class=site-description>Computer Science, Wuhan University</h2></div></header><ol class=social-menu><li><a href=https://github.com/ZYChimne target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/ZChimne target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about-me/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About Me</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/posts/2016-09-09-an-old-school-shell-hack-on-line-printer/>An old-school shell hack on a line printer</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Nov 11, 2019</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><p>It‚Äôs been too long since I last did a good hack, for no practical reason other than great hack value. In my case, these <a class=link href=https://drewdevault.com/2016/03/22/Integrating-a-VT220-into-my-life.html target=_blank rel=noopener>often amount</a> to a nostalgia for an age of computing I wasn‚Äôt present for. In a recent bid to capture more of this nostalgia, I recently picked up a dot matrix line printer, specifically the Epson LX-350 printer. This one is nice because it has a USB port, so I don‚Äôt have to break out my pile of serial cable hacks to get it talking to Linux üòÅ</p><p>This is the classic printer style, with infinite paper and a lovely noise during printing. They are also fairly simple to operate - you can just write text directly to <code>/dev/lp</code> (or <code>/dev/usb/lp9</code> in my case) and it‚Äôll print it out. Slightly more sophisticated instructions can be written to them with ANSI escape sequences, just like a terminal. They can also be rigged up to CUPS, then you can use something like <code>man -t 5 scdoc</code> to produce printouts like this:</p><p><a class=link href=https://sr.ht/gHCA.jpg target=_blank rel=noopener><img src=https://sr.ht/gHCA.jpg loading=lazy></a></p><p>Plugging the printer into Linux and writing out pages isn‚Äôt much for hack value, however. What I really wanted to make was something resembling an old-school TTY - teletypewriter. So I wrote some <a class=link href=https://git.sr.ht/~sircmpwn/lpsh target=_blank rel=noopener>glue code in Golang</a>, and soon enough I had a shell:</p><p>The glue code I wrote for this is fairly straightforward. In the simplest form, it spins up a pty (pseudo-terminal), runs <code>/bin/sh</code> in it, and writes the pty output into the line printer device. For those unaware, a pseudo-terminal is the key piece of software infrastructure for running interactive text applications. Applications which want to do things like print colored text, move the cursor around and draw a TUI, and so on, will open <code>/dev/tty</code> to open the current TTY device. For most applications used today, this is a ‚Äúpseudo-terminal‚Äù, or pty, which is a terminal emulated in userspace - i.e. by your terminal emulator. However, your terminal emulator is <em>emulating</em> a terminal - the control sequences applications send to these are backwards-compatible with 50 years of computing history. Interfaces like these are the namesake of the TTY.</p><p>Visual terminals came onto the scene later on, and in the classic computing tradition, the old hands complained that it was less useful - you could no longer write notes on your backlog, tear off a page and hand it to a colleague, or <a class=link href=https://en.wikipedia.org/wiki/Wite-Out target=_blank rel=noopener>white-out</a> mistakes. Early <a class=link href=https://en.wikipedia.org/wiki/Computer_terminal target=_blank rel=noopener>visual terminals</a> could also be plugged directly into a line printer, and you could configure them to echo to the printer or print out a screenfull of text at a time. A distinct advantage of visual terminals is not having to deal with so much bloody paper, a problem that I‚Äôve become acutely familiar with in the past few days<a class=link href=https://drewdevault.com/2019/10/30/Line-printer-shell-hack.html#fn:1 target=_blank rel=noopener>1</a>.</p><p>Getting back to the glue code, I chose Golang because setting up a TTY is a bit of a hassle in C, but in Golang it‚Äôs pretty straightforward. There is a serial port and in theory I could have plugged it in and spawned a getty on the resulting serial device - but (1) it‚Äôd be write-only, so not especially interactive without <em>hardware</em> hacks, and (2) I didn‚Äôt feel like digging out my serial cables. So:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>import &#34;git.sr.ht/~sircmpwn/pty&#34; // fork of github.com/kr/pty // ... winsize := pty.Winsize{ Cols: 160, Rows: 24, } cmd := exec.Command(&#34;/bin/sh&#34;) cmd.Env = append(os.Environ(), &#34;TERM=lp&#34;, fmt.Sprintf(&#34;COLUMNS=%d&#34;, 180)) tty, err := pty.StartWithSize(cmd, &amp;winsize) 
</span></span></code></pre></td></tr></table></div></div><p><em>P.S. We‚Äôre going to dive through the code in detail now. If you just want more cool videos of this in action, skip to the bottom.</em></p><p>I set the TERM environment variable to <code>lp</code>, for line printer, which doesn‚Äôt really exist but prevents most applications from trying anything too tricksy with their escape codes. The <code>tty</code> variable here is an <code>io.ReadWriter</code> whose output is sent to the printer and whose input is sourced from wherever, in my case from the stdin of this process<a class=link href=https://drewdevault.com/2019/10/30/Line-printer-shell-hack.html#fn:2 target=_blank rel=noopener>2</a>.</p><p>For a little more quality-of-life, I looked up Epson‚Äôs proprietary ANSI escape sequences and found out that you can tell the printer to feed back and forth in 216th‚Äù increments with the j and J escape sequences. The following code will feed 2.5‚Äù out, then back in:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>f.Write([]byte(&#34;\x1BJ\xD8\x1BJ\xD8\x1BJ\x6C&#34;)) f.Write([]byte(&#34;\x1Bj\xD8\x1Bj\xD8\x1Bj\x6C&#34;)) 
</span></span></code></pre></td></tr></table></div></div><p>Which happens to be the perfect amount to move the last-written line up out of the printer for the user to read, then back in to be written to some more. A little bit of timing logic in a goroutine manages the transition between ‚Äúspool out so the user can read the output‚Äù and ‚Äúspool in to write some more output‚Äù:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func lpmgr(in chan (interface{}), out chan ([]byte)) { // TODO: Runtime configurable option? Discover printers? dunno f, err := os.OpenFile(&#34;/dev/usb/lp9&#34;, os.O_RDWR, 0755) if err != nil { panic(err) } feed := false f.Write([]byte(&#34;\n\n\n\r&#34;)) timeout := 250 * time.Millisecond for { select { case &lt;-in: // Increase the timeout after input timeout = 1 * time.Second case data := &lt;-out: if feed { f.Write([]byte(&#34;\x1Bj\xD8\x1Bj\xD8\x1Bj\x6C&#34;)) feed = false } f.Write(lptl(data)) case &lt;-time.After(timeout): timeout = 200 * time.Millisecond if !feed { feed = true f.Write([]byte(&#34;\x1BJ\xD8\x1BJ\xD8\x1BJ\x6C&#34;)) } } } } 
</span></span></code></pre></td></tr></table></div></div><p><code>lptl</code> is a work-in-progress thing which tweaks the outgoing data for some quality-of-life changes, like changing backspace to ^H. Then, the main event loop looks something like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>inch := make(chan (interface{})) outch := make(chan ([]byte)) go lpmgr(inch, outch) inbuf := make([]byte, 4096) go func() { for { n, err := os.Stdin.Read(inbuf) if err != nil { panic(err) } tty.Write(inbuf[:n]) inch &lt;- nil } }() outbuf := make([]byte, 4096) for { n, err := tty.Read(outbuf) if err != nil { panic(err) } b := make([]byte, n) copy(b, outbuf[:n]) outch &lt;- b } 
</span></span></code></pre></td></tr></table></div></div><p>The tty will echo characters written to it, so we just write to it from stdin and increase the form feed timeout closer to the user‚Äôs input so that it‚Äôs not constantly feeding in and out as you write. The resulting system is pretty pleasant to use! I spent about hour working on improvements to it on a <a class=link href=https://live.drewdevault.com target=_blank rel=noopener>live stream</a>. You can watch the system in action on the archive here:</p><p>If you were a fly on the wall when Unix was written, it would have looked a lot like this. And remember: <a class=link href=https://www.gnu.org/fun/jokes/ed-msg.html target=_blank rel=noopener>ed is the standard text editor</a>.</p><p>?</p><p>Have a comment on one of my posts? Start a discussion in my <a class=link href=https://lists.sr.ht/~sircmpwn/public-inbox target=_blank rel=noopener>public inbox</a> by sending an email to <a class=link href="mailto:~sircmpwn/public-inbox@lists.sr.ht?Subject=Re%3A%20An%20old-school%20shell%20hack%20on%20a%20line%20printer">~sircmpwn/public-inbox@lists.sr.ht</a> [<a class=link href=https://man.sr.ht/lists.sr.ht/etiquette.md target=_blank rel=noopener>mailing list etiquette</a>]</p><hr><h3 id=articles-from-blogs-i-follow-around-the-net>Articles from blogs I follow around the net</h3><p>Happy birthday, Go!</p><p>via <a class=link href=https://blog.golang.org/feed.atom target=_blank rel=noopener>The Go Programming Language Blog</a> November 8, 2019</p><p>I‚Äôll soon be working full-time on open-source software! I‚Äôm pleased to announce that I‚Äôm joining Sourcehut. Huge thanks to Drew DeVault for making this possible. I also want to thank everyone supporting Sourcehut and allowing it to grow. Being able to do ‚Ä¶</p><p>via <a class=link href=https://emersion.fr/blog/ target=_blank rel=noopener>emersion</a> October 15, 2019</p><p>This post gives an overview of the recent updates to the Writing an OS in Rust blog and the used libraries and tools. I finished my master thesis and got my degree this month, so I only had limited time for my open source work. I still managed to perform a‚Ä¶</p><p>via <a class=link href=https://os.phil-opp.com target=_blank rel=noopener>Writing an OS in Rust</a> October 6, 2019</p><p>Generated by <a class=link href=https://git.sr.ht/~sircmpwn/openring target=_blank rel=noopener>openring</a></p><p>from Hacker News <a class=link href=https://ift.tt/2Px3ICP target=_blank rel=noopener>https://ift.tt/2Px3ICP</a></p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2020 -
2022 ZYChimne</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><ol><li><a href=#articles-from-blogs-i-follow-around-the-net>Articles from blogs I follow around the net</a></li></ol></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>